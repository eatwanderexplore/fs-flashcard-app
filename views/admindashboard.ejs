<!DOCTYPE html>
<html lang="en">
<head>
    <%- include('partials/header1.ejs') %>
</head>
<body>
    <%- include('partials/adminnavbar.ejs') %>
    <h2 class="flex justify-center text-xl m-4">Students who have not logged in this week</h2>
    
    <!-- Student table view -->
    <div class="relative overflow-x-auto shadow-md sm:rounded-lg m-4">
        <table class="w-full text-sm text-left rtl:text-right text-gray-500 dark:text-gray-400">
            <thead class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400">
                <tr>
                    <th scope="col" class="px-6 py-3">Username</th>
                    <th scope="col" class="px-6 py-3">email</th>
                    <th scope="col" class="px-6 py-3">Last Login</th>
                    <th scope="col" class="px-6 py-3">User Type</th>
                    <th scope="col" class="px-6 py-3">
                        <span class="sr-only">Edit</span>
                    </th>
                </tr>
            </thead>
            <tbody>
                <% if (userData.length !== 0) { %>
                    <% userData.forEach(function(data) { %>
                        <tr class="odd:bg-white odd:dark:bg-gray-900 even:bg-gray-50 even:dark:bg-gray-800 border-b dark:border-gray-700">
                            <th scope="row" class="px-6 py-4 font-medium text-gray-900 whitespace-nowrap dark:text-white">
                                <%= data.username %>
                            </th>
                            <td class="px-6 py-4"><%= data.email %></td>
                            <td class="px-6 py-4"><%= data.last_login %></td>
                            <td class="px-6 py-4"><%= data.role %></td>
                            <td class="px-6 py-4">
                                <button data-modal-target="crud-modal" 
                                        data-modal-toggle="crud-modal"
                                        data-username="<%= data.username %>" 
                                        data-email="<%= data.email %>"
                                        data-admin="<%= data.role %>"
                                        class="edit-user-btn font-medium text-blue-600 dark:text-blue-500 hover:underline"
                                        type="button">
                                    Edit <span class="text-white">/</span>
                                </button>
                                <button type="button" 
                                        onclick="confirmDelete('<%= data.userID %>')"
                                        class="text-red-600 hover:text-red-900">
                                    Delete
                                </button>
                            </td>
                        </tr>
                    <% }); %>
                <% } %>
            </tbody>
        </table>
    </div>

    <!-- Delete Confirmation Modal (Moved outside the table) -->
    <div id="delete-modal" 
         tabindex="-1" 
         aria-hidden="true" 
         class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <h3 class="text-lg leading-6 font-medium text-gray-900">Confirm Deletion</h3>
                <div class="mt-2 px-7 py-3">
                    <p class="text-sm text-gray-500">Are you sure you want to delete this user?</p>
                </div>
                <div class="items-center px-4 py-3">
                    <form id="delete-form" action="/deleteUser" method="POST">
                        <input type="hidden" name="userID" id="delete-user-id">
                        <button type="button"
                                class="px-4 py-2 bg-gray-500 text-white text-base font-medium rounded-md w-24 mr-2"
                                onclick="closeDeleteModal()">
                            Cancel
                        </button>
                        <button type="submit"
                                class="px-4 py-2 bg-red-600 text-white text-base font-medium rounded-md w-24">
                            Delete
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Delete modal functionality
        function confirmDelete(userID) {
            const deleteModal = document.getElementById('delete-modal');
            const deleteUserIdInput = document.getElementById('delete-user-id');
            
            if (userID) {
                deleteUserIdInput.value = userID;
                deleteModal.classList.remove('hidden');
            }
        }

        function closeDeleteModal() {
            const deleteModal = document.getElementById('delete-modal');
            deleteModal.classList.add('hidden');
        }

        // Close modal when clicking outside
        document.getElementById('delete-modal').addEventListener('click', function(event) {
            if (event.target === this) {
                closeDeleteModal();
            }
        });

        // Handle form submission
        document.getElementById('delete-form').addEventListener('submit', function(event) {
            event.preventDefault();
            const userID = document.getElementById('delete-user-id').value;
            
            fetch('/deleteUser', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ userID: userID })
            })
            .then(response => {
                if (response.ok) {
                    window.location.reload();
                } else {
                    console.error('Delete failed');
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
        });
    </script>
</body>
</html>